<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>M2.encrypt</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fira+Mono&family=Inter&display=swap');
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family:'Inter',system-ui; background:#0b0b0b; color:#fff; }
#main-content { display:block; }
header { text-align:center; font-weight:900; font-size:3rem; padding:28px 0; color:#fff; text-shadow:0 0 3px #fff,0 0 6px #fff,0 0 10px #fff; }
.container { max-width:900px; margin:40px auto; padding:30px; background:#111; border-radius:16px; display:flex; flex-direction:column; gap:20px; box-shadow:0 0 15px rgba(255,255,255,0.12),0 0 30px rgba(255,255,255,0.08); }
.password-row { display:flex; align-items:center; gap:16px; font-size:0.9rem; color:#fff; position:relative; }
.password-row span { min-width:120px; }
.password-row input { flex-grow:1; background:#000; border:1.5px solid transparent; color:#fff; padding:10px 40px 10px 14px; border-radius:12px; font-family:'Fira Mono',monospace; transition: all 0.3s ease; }
.password-row input:hover, .password-row input:focus { border-color:#fff; }
.eye-wrapper { position:absolute; right:12px; top:50%; transform:translateY(-50%); width:24px; height:24px; cursor:pointer; }
.eye-wrapper img { width:100%; height:100%; display:block; }
.eye-wrapper .eye-slash { position:absolute; top:50%; left:-2px; width:28px; height:3px; background:#fff; transform: rotate(45deg) translateY(-50%); transform-origin: center; pointer-events:none; display:none; border-radius:1px; }
.password-safety-bar { height:6px; width:100%; border-radius:4px; background:#222; margin-top:4px; overflow:hidden; }
.password-safety-fill { height:100%; width:0%; background:red; transition: width 0.3s, background 0.3s; }
textarea { width:100%; height:180px; background:#000; border:1.5px solid transparent; border-radius:14px; padding:18px; font-family:'Fira Mono',monospace; color:#fff; resize:none; outline:none; transition:all 0.3s ease; }
textarea:hover, textarea:focus { border-color:#fff; }
.output-wrapper { position:relative; }
.copy-btn { position:absolute; top:12px; right:12px; width:24px; height:24px; cursor:pointer; }
.buttons { display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-top:5px; }
button { min-width:160px; padding:12px; border-radius:9999px; font-size:14px; font-weight:700; cursor:pointer; border:2px solid #fff; position:relative; overflow:hidden; text-transform:uppercase; letter-spacing:0.1em; font-family:'Fira Mono',monospace; transition: all 0.2s ease; }
#encryptBtn { background:#000; color:#fff; box-shadow:0 0 8px #fff; }
#decryptBtn { background:#fff; color:#000; box-shadow:0 0 8px #000; }
#modeBtn { margin-top:20px; background:#f8f8f8; color:#000; font-weight:bold; min-width:200px; text-align:center; border:2px solid #fff; }
#downloadOtpBtn, #downloadEccBtn { margin-top:6px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#222; color:#fff; font-family:'Fira Mono',monospace; }
#downloadOtpBtn:hover, #downloadEccBtn:hover { background:#555; }
#errorMsg { color:#ff5555; font-weight:700; text-align:center; font-family:monospace; margin-top:6px; }
.logout-btn { margin-top:10px; align-self:flex-end; padding:8px 16px; border-radius:9999px; background:#fff; color:#000; font-family:'Fira Mono',monospace; border:none; cursor:pointer; font-weight:700; }
.logout-btn:hover { background:#ddd; }
.key-display { font-family:'Fira Mono', monospace; font-size:0.9rem; background:#222; padding:10px; border-radius:8px; margin-top:6px; word-break:break-all; white-space: pre-wrap;}
.otp-warning { font-size:0.8rem; color:#ff9999; margin-top:4px; font-family:monospace; }
</style>
</head>
<body>

<div id="main-content">
  <header>M2.encrypt</header>
  <div class="container">

    <div class="password-row" id="entryGate">
      <span>ENTER ACCESS CODE:</span>
      <input type="password" id="entryPassword" placeholder="Type access code" oninput="checkEntry()">
    </div>

    <div id="mainApp" style="display:none;">
      <div class="password-row">
        <span>Key/Password:</span>
        <input type="password" id="password" placeholder="Enter Key or Password!" oninput="updatePasswordStrength()">
        <div class="eye-wrapper" id="eyeWrapper" onclick="togglePass()">
          <img src="eye.svg" alt="Eye">
          <div class="eye-slash" id="eyeSlash"></div>
        </div>
      </div>
      <div class="otp-warning" id="otpWarning"></div>
      <div id="otpKeyDisplay" class="key-display"></div>
      <div id="eccKeyDisplay" class="key-display"></div>
      <button id="downloadOtpBtn" onclick="downloadOtpKey()" style="display:none;">Download OTP Key</button>
      <button id="downloadEccBtn" onclick="downloadEccKeys()" style="display:none;">Download ECC Keys</button>

      <div class="password-safety-bar">
        <div class="password-safety-fill" id="passwordSafetyFill"></div>
      </div>

      <textarea id="input" placeholder="Enter text here..."></textarea>

      <div class="buttons">
        <button id="encryptBtn" onclick="processText(true)">ENCRYPT</button>
        <button id="decryptBtn" onclick="processText(false)">DECRYPT</button>
      </div>

      <div class="output-wrapper">
        <textarea id="output" placeholder="Output will appear here..." readonly></textarea>
        <img class="copy-btn" id="copyBtn" src="copy.svg" onclick="copyOutput()">
      </div>

      <div id="errorMsg"></div>

      <button id="modeBtn" onclick="switchMode()">MODE: M2.OTP</button>
      <button class="logout-btn" onclick="logout()">Log Out</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
// --- Local Storage ---
window.addEventListener('DOMContentLoaded', () => {
  if(localStorage.getItem('verified') === 'true') {
    document.getElementById("entryGate").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
  }
});

function checkEntry() {
  const val = document.getElementById("entryPassword").value.toUpperCase();
  if(val === "M2") {
    localStorage.setItem('verified', 'true');
    document.getElementById("entryGate").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
  }
}

function logout() {
  localStorage.removeItem('verified');
  document.getElementById("entryGate").style.display = "flex";
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("entryPassword").value = "";
}

const password = document.getElementById("password");
const eyeSlash = document.getElementById("eyeSlash");
let showing = false;
function togglePass() {
  showing = !showing;
  password.type = showing ? "text" : "password";
  eyeSlash.style.display = showing ? "block" : "none";
}

// Password Strength
const passwordStrengthFill = document.getElementById("passwordSafetyFill");
function updatePasswordStrength() {
  const val = password.value;
  let score = 0;
  if(val.length >= 8) score++;
  if(/[A-Z]/.test(val)) score++;
  if(/[a-z]/.test(val)) score++;
  if(/[0-9]/.test(val)) score++;
  if(/[^A-Za-z0-9]/.test(val)) score++;
  let percent = (score/5)*100;
  passwordStrengthFill.style.width = percent + "%";
  passwordStrengthFill.style.background = score<=2?"red":score<=4?"orange":"green";
}

// Copy
function copyOutput() {
  const output = document.getElementById("output");
  if(output.value) navigator.clipboard.writeText(output.value);
}

// --- Modes ---
let modes = ["M2.OTP","M2.AES","M2.Crypt","M2.FREESTYLE","M2.ECC"];
let currentMode = 0;
let lastOtpKeyB64 = "";
let eccKeys = {publicKey:null, privateKey:null};

function switchMode() {
  currentMode = (currentMode+1)%modes.length;
  const modeName = modes[currentMode];
  document.getElementById("modeBtn").textContent = "MODE: " + modeName;
  document.getElementById("otpWarning").textContent =
    modeName==="M2.OTP" ? "OTP key will be auto-generated and displayed. Key must match message length for decryption." :
    modeName==="M2.FREESTYLE" ? "Freestyle: reversible encryption using password-seeded shuffle." :
    modeName==="M2.ECC" ? "ECC: generate public/private key pair for encryption." : "";
  document.getElementById("otpKeyDisplay").textContent="";
  document.getElementById("eccKeyDisplay").textContent="";
  document.getElementById("downloadOtpBtn").style.display = "none";
  document.getElementById("downloadEccBtn").style.display = "none";
}

// --- OTP ---
function generateRandomKey(length) {
  const key = new Uint8Array(length);
  crypto.getRandomValues(key);
  return key;
}

async function otpEncrypt(text) {
  const enc = new TextEncoder();
  const msg = enc.encode(text);
  const key = generateRandomKey(msg.length);
  const cipher = new Uint8Array(msg.length);
  for(let i=0;i<msg.length;i++) cipher[i] = msg[i]^key[i];
  const cipherB64 = btoa(String.fromCharCode(...cipher));
  const keyB64 = btoa(String.fromCharCode(...key));
  lastOtpKeyB64 = keyB64;
  document.getElementById("otpKeyDisplay").textContent = "OTP Key (Base64): "+keyB64;
  document.getElementById("downloadOtpBtn").style.display = "inline-block";
  return "M2."+cipherB64;
}

async function otpDecrypt(data, keyText) {
  const cipher = Uint8Array.from(atob(data.slice(3)), c=>c.charCodeAt(0));
  const key = Uint8Array.from(atob(keyText), c=>c.charCodeAt(0));
  if(key.length !== cipher.length) throw new Error("OTP key length must match ciphertext length!");
  const plain = new Uint8Array(cipher.length);
  for(let i=0;i<cipher.length;i++) plain[i] = cipher[i]^key[i];
  return new TextDecoder().decode(plain);
}

function downloadOtpKey() {
  if(!lastOtpKeyB64) return;
  const blob = new Blob([lastOtpKeyB64], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "M2_OTP_Key.txt";
  a.click();
}

// --- ECC ---
async function generateEccKeys(){
  const keyPair = await crypto.subtle.generateKey({name:"ECDH", namedCurve:"P-256"}, true, ["deriveKey","deriveBits"]);
  eccKeys.publicKey = keyPair.publicKey;
  eccKeys.privateKey = keyPair.privateKey;

  const exportedPub = await crypto.subtle.exportKey("spki", keyPair.publicKey);
  const exportedPriv = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
  const pubB64 = btoa(String.fromCharCode(...new Uint8Array(exportedPub)));
  const privB64 = btoa(String.fromCharCode(...new Uint8Array(exportedPriv)));

  document.getElementById("eccKeyDisplay").textContent = "Public Key (Base64): "+pubB64+"\nPrivate Key (Base64): "+privB64;
  document.getElementById("downloadEccBtn").style.display="inline-block";
}

// TODO: Add ECC encrypt/decrypt here (uses derived AES-GCM key)
</script>
</body>
</html>
